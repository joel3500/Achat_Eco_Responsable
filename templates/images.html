<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{% block title %} Recherche par images ‚Äî Achat Responsable {% endblock %} </title>
  <meta name="description" content="{% block desc %}Compare des articles (mat√©riaux, eau, recyclabilit√©‚Ä¶) et classe le plus √©co-responsable. Recherche aussi des vendeurs √† partir d‚Äôune image.{% endblock %}">
  <link rel="canonical" href="{{ request.url }}">
  <link rel="stylesheet" href="/static/styles.css"/>

  <style>
    /* petit style pour la liste des r√©sultats */
    .match-list{list-style:none;padding:0;margin:0;display:grid;gap:12px}
    .match{display:flex;gap:12px;align-items:flex-start;border:1px solid #1f2937;
           border-radius:10px;padding:10px;background:#0a0f1a}
    .match img{max-width:140px;border-radius:8px}
    .match .meta a{word-break:break-all}
    .match .site{font-size:.9rem;opacity:.8}
    .match .price{font-weight:600;color:#34d399}
  </style>
  
</head>
<body>
  <header class="barre">
      <h1>üîé Recherche par images</h1>
      <p class="small">
          <small>
            Uploadez une image ‚Üí puis nous retrouvons les points de vente en ligne : <br>
            Uploade l'image d'un objet que tu d√©sires acheter ( accessoire - v√™tement - v√©hicule - ... ) 
            et nous t'aidons √®a le retrouver en ligne. Avec si possible le prix qui est affich√©.
            <br><a href="/">‚Üê Retour √† la page de l'Achat Eco-Responsable</a>
          </small>
      </p>
  </header>

  <main class="container">
    <section class="card">
      <form method="post" enctype="multipart/form-data">
        <label for="file"><b>Choisir une image</b></label><br>
        <input id="file" name="file" type="file" accept="image/*" required>
        <p class="hint">Formats usuels (jpg, png, jpeg, gif, webp). Taille <5Mo svp</p>

        <!-- Aper√ßu imm√©diat de l‚Äôimage choisie -->
        <div id="previewWrap" style="margin:10px 0; display:none;">
          <img id="preview" alt="Aper√ßu"
               style="height:300px;width:auto;max-width:100%;
                      border-radius:10px;border:1px solid #1f2937;object-fit:contain"/>
        </div>

        <button class="btn primary" type="submit">Lancer la recherche</button>
      </form>
    </section>

    {% if error %}
      <div class="msg error">{{ error }}</div>
    {% endif %}

    {% if result %}
      <section class="card">
        <h3>Image s√©lectionn√©e</h3>
        {% if result.query_preview_b64 %}
          <img src="{{ result.query_preview_b64 }}" alt="Image requ√™te"
               style="height:300px;width:auto;max-width:100%;
                      border-radius:10px;border:1px solid #1f2937;object-fit:contain"/>
        {% endif %}
      </section>

      <section class="card">
        <h3>Correspondances trouv√©es</h3>
        {% if result['items']|length > 0 %}
          <ul class="match-list">
            {% for it in result['items'] %}
              <li class="match">
                {% if it.thumb %}
                  <a href="{{ it.url }}" target="_blank" rel="noopener">
                    <img src="{{ it.thumb }}" alt="aper√ßu" loading="lazy" />
                  </a>
                {% endif %}
                <div class="meta">
                  <a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.url }}</a>
                  <div class="site">{{ it.site }}</div>
                  {% if it.price %}<div class="price">{{ it.price }}</div>{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="hint">Aucune page similaire n‚Äôa √©t√© d√©tect√©e.</p>
        {% endif %}
      </section>
    {% endif %}
  </main>

  <footer>
    <small>
      <p>
        ¬© Tous droits r√©serv√©s ‚Ä¢ Automne 2025 ‚Ä¢ Projet √®a int√©r√™t √âcologique, incitant les lobis industriels √®a faire de meilleurs choix pour la pr√©servation de notre environnement √®a tous. 
        Id√©e du Professeur Marc Priv√©, enseignant au d√©partement d'Administration de l'UQAC. <br> 
        Produit par JOEL SAND√â, du Saguenay Lac Saint-Jean. <br><br>

        L'argent d'accord, mais notre environnement d'abord. Certe on ne peut pas faire d'omelettes sans casser d'oeufs, mais faisons le moins de mal dans la mesure du possible. <br><br>
        
        Soyons nombreux √®a utiliser ce site, pour contraindre les fabriquants √®a se soucier de notre environnement. <br>
        Partagez Massivement ! Et pr√©servons notre environnement. <br><br>
        C'est JoJo qui a fait le son.
      </p>  
    </small>
  </footer>

  <script>
    // Aper√ßu imm√©diat du fichier choisi
    const input = document.getElementById('file');
    const wrap  = document.getElementById('previewWrap');
    const img   = document.getElementById('preview');
    input.addEventListener('change', () => {
      const f = input.files && input.files[0];
      if (!f) { wrap.style.display = 'none'; img.removeAttribute('src'); return; }
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; wrap.style.display = 'block'; };
      reader.readAsDataURL(f);
    });
  </script>
</body>
</html>
